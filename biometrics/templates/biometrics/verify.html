{% extends 'accounts/base.html' %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow-lg rounded-3">
    <div class="card-body p-4">
      <h2 class="mb-4 text-center text-primary fw-bold">Verify User</h2>

      <!-- Face Verification -->
      <div class="mb-4 text-center">
        <div class="d-flex flex-column align-items-center">
          <!-- Video Preview -->
          <video id="video" autoplay class="border rounded shadow-sm mb-3" width="320" height="240"></video>

          <!-- Camera Fail Message -->
          <p id="cameraFailMsg" class="text-danger fw-semibold d-none">
            ‚ùå Camera not available. Please upload an image instead.
          </p>

          <!-- Canvas (hidden) -->
          <canvas id="canvas" class="d-none"></canvas>

          <!-- Upload Fallback -->
          <div id="uploadWrapper" class="w-75 mt-2 d-none">
            <input 
              type="file" 
              id="faceInput" 
              accept="image/*" 
              capture="user" 
              class="form-control"
            />
          </div>
        </div>
      </div>

      <!-- Verify Button -->
      <div class="d-flex justify-content-center">
        <button id="verifyBtn" type="button" class="btn btn-primary btn-lg">
          üîç Verify
        </button>
      </div>

      <!-- Message Box -->
      <div id="messageBox" class="mt-4 text-center fw-bold"></div>
    </div>
  </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const messageBox = document.getElementById("messageBox");
const cameraFailMsg = document.getElementById("cameraFailMsg");
const faceInput = document.getElementById("faceInput");
const uploadWrapper = document.getElementById("uploadWrapper");

// Camera setup
async function initCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        cameraFail();
        return;
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = "block";
        cameraFailMsg.classList.add("d-none");
        uploadWrapper.classList.add("d-none");
    } catch (err) {
        cameraFail();
        console.warn("Camera init failed:", err);
    }
}

function cameraFail() {
    video.style.display = "none";
    cameraFailMsg.classList.remove("d-none");
    uploadWrapper.classList.remove("d-none");
}

// Show messages
function showMessage(text, color) {
    messageBox.textContent = text;
    messageBox.style.color = color;
}

// Safe fetch
async function safeFetch(url, options) {
    const res = await fetch(url, options);
    const contentType = res.headers.get("content-type");
    if (contentType && contentType.indexOf("application/json") !== -1) {
        return await res.json();
    } else {
        const text = await res.text();
        throw new Error("Server did not return JSON:\n" + text);
    }
}

// Verify button
document.getElementById("verifyBtn").onclick = async () => {
    let formData = new FormData();

    if (video.style.display !== "none") {
        // Use video frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
        formData.append("face_image", blob, "verify.png");
    } else if (faceInput.files.length) {
        // Use uploaded file
        formData.append("face_image", faceInput.files[0]);
    } else {
        return showMessage("‚ùå Camera not available. Please upload an image.", "red");
    }

    try {
        const result = await safeFetch("", {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            body: formData
        });

        if (result.ok) {
            showMessage(`‚úÖ Verified (confidence ${result.confidence})`, "green");
        } else {
            showMessage("‚ùå " + result.error, "red");
        }
    } catch (err) {
        showMessage("‚ùå Request failed: " + err, "red");
    }
};

// Initialize
initCamera();
</script>
{% endblock %}
